name: "publish"

on:
    workflow_dispatch:
    push:
        tags:
            - "v*"
        # branches:
        #     - release

# This workflow will trigger on each push to the `release` branch to create or update a GitHub release, build your app, and upload the artifacts to the release.

jobs:
    publish-tauri:
        permissions:
            contents: write
        strategy:
            fail-fast: false
            matrix:
                include:
                    # - platform: 'macos-latest' # for Arm based macs (M1 and above).
                    #   args: '--target aarch64-apple-darwin'
                    # - platform: 'macos-latest' # for Intel based macs.
                    #   args: '--target x86_64-apple-darwin'
                    # - platform: 'ubuntu-22.04' # for Tauri v1 you could replace this with ubuntu-20.04.
                    #   args: ''
                    - platform: "windows-latest"
                      args: ""

        runs-on: ${{ matrix.platform }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: setup node
              uses: actions/setup-node@v4
              with:
                  node-version: lts/*

            - uses: pnpm/action-setup@v4
              name: Install pnpm
              with:
                  cache: true

            - name: install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  # Those targets are only used on macos runners so it's in an `if` to slightly speed up windows and linux builds.
                  targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

            - name: install dependencies (ubuntu only)
              if: matrix.platform == 'ubuntu-22.04' # This must match the platform value defined above.
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.0-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
              # webkitgtk 4.0 is for Tauri v1 - webkitgtk 4.1 is for Tauri v2.
              # You can remove the one that doesn't apply to your app to speed up the workflow a bit.

            - name: Rust cache
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: "./src-tauri -> target"

            - name: install frontend dependencies
              run: pnpm install # change this to npm, pnpm or bun depending on which one you use.

            - name: Get previous tag
              id: previous_tag
              shell: pwsh
              run: |
                  $tags = git tag --sort=-creatordate | Where-Object { $_ -like "v*" }
                  if ($tags.Count -gt 1) {
                      $previousTag = $tags[1]
                      echo "previous_tag=$previousTag" >> $env:GITHUB_OUTPUT
                  } else {
                      echo "previous_tag=" >> $env:GITHUB_OUTPUT
                  }

            - name: Generate commit diff
              id: commit_diff
              shell: pwsh
              run: |
                  if (-not [string]::IsNullOrEmpty("${{ steps.previous_tag.outputs.previous_tag }}")) {
                      $diffLines = git log "${{ steps.previous_tag.outputs.previous_tag }}...${{ github.ref_name }}" --oneline
                      $diff = $diffLines | ForEach-Object { $_ -replace '\s*\([^)]*\)\s*', ' ' } | ForEach-Object { "- $_" } | Join-String -Separator "`n`n"
                      $diffBody = "## 本次更新内容 (${{ steps.previous_tag.outputs.previous_tag }} → ${{ github.ref_name }})\n\n$diff\n\n"
                      echo "commit_diff=$diffBody" >> $env:GITHUB_OUTPUT
                  } else {
                      echo "commit_diff=" >> $env:GITHUB_OUTPUT
                  }

            - uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}
              with:
                  tagName: ${{ github.ref_name }} # the action automatically replaces \_\_VERSION\_\_ with the app version.
                  releaseName: "Duet Night Abyss Builder v__VERSION__"
                  releaseBody: "${{ steps.commit_diff.outputs.commit_diff }}

                      **Full Changelog**: ${{ steps.previous_tag.outputs.previous_tag && format('https://github.com/pa001024/dna-builder/compare/{0}...{1}', steps.previous_tag.outputs.previous_tag, github.ref_name) || format('https://github.com/pa001024/dna-builder/commits/{0}', github.ref_name) }}

                      > [!TIP]

                      > Github 请在下方下载

                      > 夸克网盘链接：https://pan.quark.cn/s/1419bbc8aa2d
                      "
                  releaseDraft: true
                  prerelease: false
                  args: ${{ matrix.args }}

            - name: Add summary
              if: success() && github.event_name != 'pull_request'
              shell: pwsh
              run: |
                  $summary = "
                  > [!TIP]
                  > 发布成功
                  > [下载最新的稳定版本](https://github.com/pa001024/dna-builder/releases/latest/) 
                  "

                  echo $summary >> $Env:GITHUB_STEP_SUMMARY
