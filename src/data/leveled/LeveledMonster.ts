import { monsterMap } from "../d"
import { type DynamicMonster, Faction, type Monster } from "../data-types"

export const MOB_LEVEL_UP = [
    { atk: 0.1, hp: 0.4, es: 0.4, rhp: 1, res: 1 },
    { atk: 0.1136, hp: 0.4594, es: 0.4594, rhp: 1.0422, res: 1.0422 },
    { atk: 0.1278, hp: 0.5229, es: 0.5229, rhp: 1.086, res: 1.086 },
    { atk: 0.1427, hp: 0.5906, es: 0.5906, rhp: 1.1305, res: 1.1305 },
    { atk: 0.1582, hp: 0.6623, es: 0.6623, rhp: 1.1774, res: 1.1774 },
    { atk: 0.1744, hp: 0.7381, es: 0.7381, rhp: 1.3988, res: 1.3988 },
    { atk: 0.1912, hp: 0.8181, es: 0.8181, rhp: 1.4474, res: 1.4474 },
    { atk: 0.2087, hp: 0.9021, es: 0.9021, rhp: 1.5012, res: 1.5012 },
    { atk: 0.2268, hp: 0.9903, es: 0.9903, rhp: 1.5589, res: 1.5589 },
    { atk: 0.2456, hp: 1.0825, es: 1.0825, rhp: 1.6157, res: 1.6157 },
    { atk: 0.2637, hp: 1.1992, es: 1.1992, rhp: 1.8331, res: 1.8331 },
    { atk: 0.2824, hp: 1.3217, es: 1.3217, rhp: 1.8921, res: 1.8921 },
    { atk: 0.3016, hp: 1.45, es: 1.45, rhp: 1.9527, res: 1.9527 },
    { atk: 0.3213, hp: 1.5842, es: 1.5842, rhp: 2.0162, res: 2.0162 },
    { atk: 0.3416, hp: 1.7242, es: 1.7242, rhp: 2.0813, res: 2.0813 },
    { atk: 0.3623, hp: 1.8701, es: 1.8701, rhp: 2.3128, res: 2.3128 },
    { atk: 0.3836, hp: 2.0218, es: 2.0218, rhp: 2.3809, res: 2.3809 },
    { atk: 0.4054, hp: 2.1793, es: 2.1793, rhp: 2.4505, res: 2.4505 },
    { atk: 0.4278, hp: 2.3427, es: 2.3427, rhp: 2.5186, res: 2.5186 },
    { atk: 0.4506, hp: 2.512, es: 2.512, rhp: 2.5897, res: 2.5897 },
    { atk: 0.469, hp: 2.7251, es: 2.7251, rhp: 2.8339, res: 2.8339 },
    { atk: 0.4876, hp: 2.8604, es: 2.8604, rhp: 2.9053, res: 2.9053 },
    { atk: 0.5064, hp: 2.9958, es: 2.9958, rhp: 2.9795, res: 2.9795 },
    { atk: 0.5253, hp: 3.1312, es: 3.1312, rhp: 3.0538, res: 3.0538 },
    { atk: 0.5445, hp: 3.2666, es: 3.2666, rhp: 3.1288, res: 3.1288 },
    { atk: 0.5638, hp: 3.4019, es: 3.4019, rhp: 3.3098, res: 3.3098 },
    { atk: 0.5834, hp: 3.5373, es: 3.5373, rhp: 3.5538, res: 3.5538 },
    { atk: 0.6031, hp: 3.6727, es: 3.6727, rhp: 3.6327, res: 3.6327 },
    { atk: 0.623, hp: 3.8081, es: 3.8081, rhp: 3.7117, res: 3.7117 },
    { atk: 0.6803, hp: 3.9435, es: 3.9435, rhp: 4.6347, res: 4.6347 },
    { atk: 0.7356, hp: 4.3258, es: 4.3258, rhp: 5.2894, res: 5.2894 },
    { atk: 0.7927, hp: 4.7081, es: 4.7081, rhp: 5.6822, res: 5.6822 },
    { atk: 0.8518, hp: 5.0904, es: 5.0904, rhp: 6.1093, res: 6.1093 },
    { atk: 0.9127, hp: 5.4727, es: 5.4727, rhp: 6.5626, res: 6.5626 },
    { atk: 0.9755, hp: 5.855, es: 5.855, rhp: 7.0411, res: 7.0411 },
    { atk: 1.0402, hp: 6.2373, es: 6.2373, rhp: 7.932, res: 7.932 },
    { atk: 1.1068, hp: 6.6197, es: 6.6197, rhp: 8.4791, res: 8.4791 },
    { atk: 1.1753, hp: 7.002, es: 7.002, rhp: 9.0506, res: 9.0506 },
    { atk: 1.2457, hp: 7.3843, es: 7.3843, rhp: 9.639, res: 9.639 },
    { atk: 1.7813, hp: 7.7666, es: 7.7666, rhp: 10.2424, res: 10.2424 },
    { atk: 1.8928, hp: 9.0641, es: 9.0641, rhp: 11.374, res: 11.374 },
    { atk: 2.0073, hp: 10.5167, es: 10.5167, rhp: 12.049, res: 12.049 },
    { atk: 2.1249, hp: 12.021, es: 12.021, rhp: 12.7533, res: 12.7533 },
    { atk: 2.2454, hp: 14.9078, es: 14.9078, rhp: 13.486, res: 13.486 },
    { atk: 2.3689, hp: 14.6001, es: 14.6001, rhp: 14.2496, res: 14.2496 },
    { atk: 2.4955, hp: 17.7965, es: 17.7965, rhp: 15.6742, res: 15.6742 },
    { atk: 2.625, hp: 21.3023, es: 21.3023, rhp: 16.5238, res: 16.5238 },
    { atk: 2.7576, hp: 25.1177, es: 25.1177, rhp: 17.4033, res: 17.4033 },
    { atk: 2.8931, hp: 29.2425, es: 29.2425, rhp: 18.3174, res: 18.3174 },
    { atk: 3.9186, hp: 43.9935, es: 43.9935, rhp: 19.2607, res: 19.2607 },
    { atk: 4.0942, hp: 55.4108, es: 55.4108, rhp: 20.4749, res: 20.4749 },
    { atk: 4.2735, hp: 67.9608, es: 67.9608, rhp: 22.0835, res: 22.0835 },
    { atk: 4.4564, hp: 81.6436, es: 81.6436, rhp: 23.1679, res: 23.1679 },
    { atk: 4.6429, hp: 96.459, es: 96.459, rhp: 24.2848, res: 24.2848 },
    { atk: 4.8331, hp: 112.4072, es: 112.4072, rhp: 25.4393, res: 25.4393 },
    { atk: 5.027, hp: 129.488, es: 129.488, rhp: 27.5836, res: 27.5836 },
    { atk: 5.2245, hp: 147.7016, es: 147.7016, rhp: 28.8534, res: 28.8534 },
    { atk: 5.4256, hp: 167.0479, es: 167.0479, rhp: 30.1615, res: 30.1615 },
    { atk: 5.6303, hp: 187.5269, es: 187.5269, rhp: 31.5084, res: 31.5084 },
    { atk: 7.0948, hp: 275.2136, es: 275.2136, rhp: 34.3218, res: 34.3218 },
    { atk: 7.3381, hp: 314.106, es: 314.106, rhp: 36.197, res: 36.197 },
    { atk: 7.5855, hp: 355.2256, es: 355.2256, rhp: 38.1429, res: 38.1429 },
    { atk: 7.8368, hp: 398.5723, es: 398.5723, rhp: 40.1737, res: 40.1737 },
    { atk: 8.0922, hp: 444.1463, es: 444.1463, rhp: 42.2955, res: 42.2955 },
    { atk: 8.3516, hp: 491.9474, es: 491.9474, rhp: 47.1547, res: 47.1547 },
    { atk: 8.615, hp: 541.9757, es: 541.9757, rhp: 49.1288, res: 49.1288 },
    { atk: 8.8824, hp: 594.2313, es: 594.2313, rhp: 51.584, res: 51.584 },
    { atk: 9.1539, hp: 648.714, es: 648.714, rhp: 54.1487, res: 54.1487 },
    { atk: 9.4293, hp: 705.4239, es: 705.4239, rhp: 56.7848, res: 56.7848 },
    { atk: 11.2947, hp: 1135.5596, es: 1135.5596, rhp: 59.4121, res: 59.4121 },
    { atk: 11.6691, hp: 1404.135, es: 1404.135, rhp: 70.1921, res: 70.1921 },
    { atk: 12.0493, hp: 1672.7104, es: 1672.7104, rhp: 75.947, res: 75.947 },
    { atk: 12.4353, hp: 1941.2858, es: 1941.2858, rhp: 81.9333, res: 81.9333 },
    { atk: 12.8271, hp: 2209.8612, es: 2209.8612, rhp: 88.188, res: 88.188 },
    { atk: 13.2247, hp: 2478.4366, es: 2478.4366, rhp: 97.212, res: 97.212 },
    { atk: 13.628, hp: 2747.012, es: 2747.012, rhp: 104.2304, res: 104.2304 },
    { atk: 14.0372, hp: 3015.5874, es: 3015.5874, rhp: 111.5551, res: 111.5551 },
    { atk: 14.4521, hp: 3284.1628, es: 3284.1628, rhp: 119.2427, res: 119.2427 },
    { atk: 14.8728, hp: 3552.7382, es: 3552.7382, rhp: 127.2364, res: 127.2364 },
    { atk: 17.8744, hp: 6507.0675, es: 6507.0675, rhp: 135.5639, res: 135.5639 },
    { atk: 18.1317, hp: 6913.7593, es: 6913.7593, rhp: 142.3421, res: 142.3421 },
    { atk: 18.3902, hp: 7320.451, es: 7320.451, rhp: 149.4592, res: 149.4592 },
    { atk: 18.6501, hp: 7727.1427, es: 7727.1427, rhp: 156.9322, res: 156.9322 },
    { atk: 18.9112, hp: 8133.8344, es: 8133.8344, rhp: 164.7788, res: 164.7788 },
    { atk: 19.1735, hp: 8540.5262, es: 8540.5262, rhp: 173.0177, res: 173.0177 },
    { atk: 19.4371, hp: 8947.2179, es: 8947.2179, rhp: 181.6686, res: 181.6686 },
    { atk: 19.702, hp: 9353.9096, es: 9353.9096, rhp: 190.752, res: 190.752 },
    { atk: 19.9681, hp: 9760.6013, es: 9760.6013, rhp: 200.2896, res: 200.2896 },
    { atk: 20.2354, hp: 10167.293, es: 10167.293, rhp: 210.3041, res: 210.3041 },
    { atk: 20.504, hp: 10573.9848, es: 10573.9848, rhp: 220.8193, res: 220.8193 },
    { atk: 20.7739, hp: 10980.6765, es: 10980.6765, rhp: 231.8603, res: 231.8603 },
    { atk: 20.8367, hp: 11387.3682, es: 11387.3682, rhp: 243.4533, res: 243.4533 },
    { atk: 20.8994, hp: 11794.0599, es: 11794.0599, rhp: 255.626, res: 255.626 },
    { atk: 20.9622, hp: 12200.7516, es: 12200.7516, rhp: 268.4073, res: 268.4073 },
    { atk: 21.025, hp: 12607.4434, es: 12607.4434, rhp: 281.8276, res: 281.8276 },
    { atk: 21.0877, hp: 13014.1351, es: 13014.1351, rhp: 295.919, res: 295.919 },
    { atk: 21.1505, hp: 13420.8268, es: 13420.8268, rhp: 310.715, res: 310.715 },
    { atk: 21.2132, hp: 13827.5185, es: 13827.5185, rhp: 326.2507, res: 326.2507 },
    { atk: 21.276, hp: 14234.2103, es: 14234.2103, rhp: 342.5632, res: 342.5632 },
    { atk: 22.594, hp: 14640.902, es: 14640.902, rhp: 359.6914, res: 359.6914 },
    { atk: 22.7613, hp: 17622.0701, es: 17622.0701, rhp: 377.676, res: 377.676 },
    { atk: 22.9287, hp: 20603.2383, es: 20603.2383, rhp: 396.5598, res: 396.5598 },
    { atk: 23.0961, hp: 23584.4065, es: 23584.4065, rhp: 416.3878, res: 416.3878 },
    { atk: 23.2634, hp: 26565.5747, es: 26565.5747, rhp: 437.2071, res: 437.2071 },
    { atk: 23.4308, hp: 29546.7428, es: 29546.7428, rhp: 459.0675, res: 459.0675 },
    { atk: 23.5982, hp: 32527.911, es: 32527.911, rhp: 482.0209, res: 482.0209 },
    { atk: 23.7655, hp: 35509.0792, es: 35509.0792, rhp: 506.1219, res: 506.1219 },
    { atk: 23.9329, hp: 38490.2474, es: 38490.2474, rhp: 531.428, res: 531.428 },
    { atk: 24.1003, hp: 41471.4156, es: 41471.4156, rhp: 557.9994, res: 557.9994 },
    { atk: 24.2676, hp: 44452.5837, es: 44452.5837, rhp: 585.8994, res: 585.8994 },
    { atk: 24.435, hp: 47433.7519, es: 47433.7519, rhp: 615.1944, res: 615.1944 },
    { atk: 24.6023, hp: 50414.9201, es: 50414.9201, rhp: 645.9541, res: 645.9541 },
    { atk: 24.7697, hp: 53396.0883, es: 53396.0883, rhp: 678.2518, res: 678.2518 },
    { atk: 24.9371, hp: 56377.2564, es: 56377.2564, rhp: 712.1644, res: 712.1644 },
    { atk: 25.1044, hp: 59358.4246, es: 59358.4246, rhp: 747.7726, res: 747.7726 },
    { atk: 25.2718, hp: 62339.5928, es: 62339.5928, rhp: 785.1612, res: 785.1612 },
    { atk: 25.4392, hp: 65320.761, es: 65320.761, rhp: 824.4193, res: 824.4193 },
    { atk: 25.6065, hp: 68301.9291, es: 68301.9291, rhp: 865.6403, res: 865.6403 },
    { atk: 25.7739, hp: 71283.0973, es: 71283.0973, rhp: 908.9223, res: 908.9223 },
    { atk: 29.2885, hp: 74264.2655, es: 74264.2655, rhp: 954.3684, res: 954.3684 },
    { atk: 29.5973, hp: 77451.4422, es: 77451.4422, rhp: 1002.0868, res: 1002.0868 },
    { atk: 29.9061, hp: 80638.6188, es: 80638.6188, rhp: 1052.1911, res: 1052.1911 },
    { atk: 30.215, hp: 83825.7955, es: 83825.7955, rhp: 1104.8007, res: 1104.8007 },
    { atk: 30.5238, hp: 87012.9722, es: 87012.9722, rhp: 1160.0407, res: 1160.0407 },
    { atk: 30.8326, hp: 90200.1488, es: 90200.1488, rhp: 1218.0428, res: 1218.0428 },
    { atk: 31.1414, hp: 93387.3255, es: 93387.3255, rhp: 1278.9449, res: 1278.9449 },
    { atk: 31.4503, hp: 96574.5022, es: 96574.5022, rhp: 1342.8921, res: 1342.8921 },
    { atk: 31.7591, hp: 99761.6788, es: 99761.6788, rhp: 1410.0368, res: 1410.0368 },
    { atk: 32.0679, hp: 102948.8555, es: 102948.8555, rhp: 1480.5386, res: 1480.5386 },
    { atk: 32.3767, hp: 106136.0322, es: 106136.0322, rhp: 1554.5655, res: 1554.5655 },
    { atk: 32.6856, hp: 109323.2089, es: 109323.2089, rhp: 1632.2938, res: 1632.2938 },
    { atk: 32.9944, hp: 112510.3855, es: 112510.3855, rhp: 1713.9085, res: 1713.9085 },
    { atk: 33.3032, hp: 115697.5622, es: 115697.5622, rhp: 1799.6039, res: 1799.6039 },
    { atk: 33.612, hp: 118884.7389, es: 118884.7389, rhp: 1889.5841, res: 1889.5841 },
    { atk: 33.9209, hp: 122071.9155, es: 122071.9155, rhp: 1984.0633, res: 1984.0633 },
    { atk: 34.2297, hp: 125259.0922, es: 125259.0922, rhp: 2083.2665, res: 2083.2665 },
    { atk: 34.5385, hp: 128446.2689, es: 128446.2689, rhp: 2187.4298, res: 2187.4298 },
    { atk: 34.8473, hp: 131633.4456, es: 131633.4456, rhp: 2296.8013, res: 2296.8013 },
    { atk: 35.1562, hp: 134820.6222, es: 134820.6222, rhp: 2411.6414, res: 2411.6414 },
    { atk: 35.465, hp: 138007.7989, es: 138007.7989, rhp: 2532.2234, res: 2532.2234 },
    { atk: 35.7738, hp: 141194.9756, es: 141194.9756, rhp: 2658.8346, res: 2658.8346 },
    { atk: 36.0826, hp: 144382.1522, es: 144382.1522, rhp: 2791.7763, res: 2791.7763 },
    { atk: 36.3915, hp: 147569.3289, es: 147569.3289, rhp: 2931.3651, res: 2931.3651 },
    { atk: 36.7003, hp: 150756.5056, es: 150756.5056, rhp: 3077.9334, res: 3077.9334 },
    { atk: 37.0091, hp: 153943.6822, es: 153943.6822, rhp: 3231.8301, res: 3231.8301 },
    { atk: 37.3179, hp: 157130.8589, es: 157130.8589, rhp: 3393.4216, res: 3393.4216 },
    { atk: 37.6268, hp: 160318.0356, es: 160318.0356, rhp: 3563.0926, res: 3563.0926 },
    { atk: 37.9356, hp: 163505.2123, es: 163505.2123, rhp: 3741.2473, res: 3741.2473 },
    { atk: 38.2444, hp: 166692.3889, es: 166692.3889, rhp: 3928.3096, res: 3928.3096 },
    { atk: 47.818, hp: 169879.5656, es: 169879.5656, rhp: 4124.7251, res: 4124.7251 },
    { atk: 49.2525, hp: 178373.5439, es: 178373.5439, rhp: 4330.9614, res: 4330.9614 },
    { atk: 50.687, hp: 186867.5222, es: 186867.5222, rhp: 4547.5095, res: 4547.5095 },
    { atk: 52.1216, hp: 195361.5004, es: 195361.5004, rhp: 4774.8849, res: 4774.8849 },
    { atk: 53.5561, hp: 203855.4787, es: 203855.4787, rhp: 5013.6292, res: 5013.6292 },
    { atk: 54.9907, hp: 212349.457, es: 212349.457, rhp: 5264.3106, res: 5264.3106 },
    { atk: 56.4252, hp: 220843.4353, es: 220843.4353, rhp: 5527.5262, res: 5527.5262 },
    { atk: 57.8597, hp: 229337.4136, es: 229337.4136, rhp: 5803.9025, res: 5803.9025 },
    { atk: 59.2943, hp: 237831.3918, es: 237831.3918, rhp: 6094.0976, res: 6094.0976 },
    { atk: 60.7288, hp: 246325.3701, es: 246325.3701, rhp: 6398.8025, res: 6398.8025 },
    { atk: 62.1633, hp: 254819.3484, es: 254819.3484, rhp: 6718.7426, res: 6718.7426 },
    { atk: 63.5979, hp: 263313.3267, es: 263313.3267, rhp: 7054.6797, res: 7054.6797 },
    { atk: 65.0324, hp: 271807.305, es: 271807.305, rhp: 7407.4137, res: 7407.4137 },
    { atk: 66.467, hp: 280301.2832, es: 280301.2832, rhp: 7777.7844, res: 7777.7844 },
    { atk: 67.9015, hp: 288795.2615, es: 288795.2615, rhp: 8166.6736, res: 8166.6736 },
    { atk: 69.336, hp: 297289.2398, es: 297289.2398, rhp: 8575.0073, res: 8575.0073 },
    { atk: 70.7706, hp: 305783.2181, es: 305783.2181, rhp: 9003.7577, res: 9003.7577 },
    { atk: 72.2051, hp: 314277.1964, es: 314277.1964, rhp: 9453.9455, res: 9453.9455 },
    { atk: 73.6397, hp: 322771.1746, es: 322771.1746, rhp: 9926.6428, res: 9926.6428 },
    { atk: 75.0742, hp: 331265.1529, es: 331265.1529, rhp: 10422.975, res: 10422.975 },
    { atk: 76.5087, hp: 339759.1312, es: 339759.1312, rhp: 10944.1237, res: 10944.1237 },
    { atk: 77.9433, hp: 348253.1095, es: 348253.1095, rhp: 11491.3299, res: 11491.3299 },
    { atk: 79.3778, hp: 356747.0877, es: 356747.0877, rhp: 12065.8964, res: 12065.8964 },
    { atk: 80.8123, hp: 365241.066, es: 365241.066, rhp: 12669.1912, res: 12669.1912 },
    { atk: 82.2469, hp: 373735.0443, es: 373735.0443, rhp: 13302.6508, res: 13302.6508 },
    { atk: 83.6814, hp: 382229.0226, es: 382229.0226, rhp: 13967.7833, res: 13967.7833 },
    { atk: 85.116, hp: 390723.0009, es: 390723.0009, rhp: 14666.1725, res: 14666.1725 },
    { atk: 86.5505, hp: 399216.9791, es: 399216.9791, rhp: 15399.4811, res: 15399.4811 },
    { atk: 87.985, hp: 407710.9574, es: 407710.9574, rhp: 16169.4552, res: 16169.4552 },
    { atk: 89.4196, hp: 416204.9357, es: 416204.9357, rhp: 16977.9279, res: 16977.9279 },
    { atk: 90.8541, hp: 424698.914, es: 424698.914, rhp: 17826.8243, res: 17826.8243 },
]

export class LeveledMonster implements DynamicMonster {
    id: number
    n: string
    t?: "Rescue_Elite_Monster" | "Elite_Monster" | "Boss"
    f: Faction
    atk: number
    def: number
    hp: number
    es?: number
    tn?: number

    _等级: number = 1
    _baseData: Monster

    currentHP: number
    currentShield: number
    currentWarPose: number

    constructor(
        id: number | Monster,
        等级 = 180,
        public isRouge = false
    ) {
        let mData = typeof id === "number" ? monsterMap.get(id) : id
        if (!mData) {
            console.error(`怪物 "${id}" 未在静态表中找到`)
            mData = monsterMap.get(130)!
        }
        this._baseData = mData

        this.id = mData.id
        this.n = mData.n
        this.f = mData.f || Faction.其他
        this.atk = mData.atk
        this.def = mData.def
        this.hp = mData.hp
        if (mData.t !== undefined) this.t = mData.t
        if (mData.es !== undefined) this.es = mData.es
        if (mData.tn !== undefined) this.tn = mData.tn

        this.currentHP = this.hp
        this.currentShield = this.es || 0
        this.currentWarPose = this.tn || 0

        if (等级 > 1) {
            this.等级 = 等级
        }
    }

    get currentHPType() {
        if (this.currentShield > 0) {
            return "护盾"
        }
        return "生命"
    }

    get currentHPValue() {
        if (this.currentHPType === "护盾") {
            return this.currentShield
        }
        return this.currentHP
    }

    resetHP() {
        this.currentHP = this.hp
        this.currentShield = this.es || 0
    }

    get 等级(): number {
        return this._等级
    }

    set 等级(value: number) {
        if (value !== undefined) {
            const _new = Math.max(1, Math.min(180, value))
            if (this._等级 !== _new) {
                this._等级 = _new
                this.updatePropertiesByLevel(_new)
            }
        }
    }

    private updatePropertiesByLevel(level: number): void {
        const clampedLevel = Math.max(1, Math.min(180, level))

        const multiplier = MOB_LEVEL_UP[clampedLevel - 1]

        this.atk = Math.round(this._baseData.atk * multiplier.atk)
        this.hp = Math.round(this._baseData.hp * (this.isRouge ? multiplier.rhp : multiplier.hp))
        if (this.es !== undefined) {
            this.es = Math.round((this._baseData.es || 0) * (this.isRouge ? multiplier.res : multiplier.es))
        }
    }

    static properties = ["n", "t", "f", "atk", "def", "hp", "es", "tn"] as const

    getProperties(): Partial<Monster> {
        const properties: Partial<Monster> = {}
        LeveledMonster.properties.forEach(prop => {
            if (this[prop] !== undefined) properties[prop] = this[prop] as any
        })
        return properties
    }

    getHPByLevel(level: number): number {
        return Math.round(this._baseData.hp * (this.isRouge ? MOB_LEVEL_UP[level - 1].rhp : MOB_LEVEL_UP[level - 1].hp))
    }

    get url() {
        return LeveledMonster.url(this._baseData.icon)
    }
    static url(icon?: string) {
        return icon ? `/imgs/webp/T_Head_${icon}.webp` : "/imgs/webp/T_Head_Empty.webp"
    }
}
