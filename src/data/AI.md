# 角色构建与伤害计算系统 (CharBuild)

## 1. 基本定义

### 1.1 核心类

- **类名**: `CharBuild`
- **用途**: 用于计算角色的属性、武器伤害和技能伤害的核心类

### 1.2 输入参数

| 参数名          | 中文名         | 类型            | 默认值 | 描述                                       |
| --------------- | -------------- | --------------- | ------ | ------------------------------------------ |
| char            | 角色与等级     | `LeveledChar`   |        | 角色及其等级信息                           |
| hpPercent       | 当前生命百分比 | `number`        |        | 角色当前生命值占最大生命值的百分比（0-1）  |
| resonanceGain   | 和鸣增益       | `number`        |        | 角色的和鸣增益效果                         |
| mods            | 角色 MOD 列表  | `LeveledMod[]`  | []     | 可选, 角色装备的 MOD 列表                  |
| buffs           | BUFF 列表      | `LeveledBuff[]` | []     | 可选, 角色当前的 BUFF 列表                 |
| melee           | 近战武器       | `LeveledWeapon` |        | 角色装备的近战武器及其等级信息             |
| ranged          | 远程武器       | `LeveledWeapon` |        | 角色装备的远程武器及其等级信息             |
| skillLevel      | 技能等级       | `number`        | 10     | 可选, 角色装备的技能等级信息               |
| baseName        | 武器或技能名   | `string`        |        | 要计算的武器或技能名称                     |
| enemyType       | 敌方类型       | `string`        | "小型" | 可选, 敌方目标的类型（小型/大型/首领）     |
| enemyLevel      | 敌方等级       | `number`        | 80     | 可选, 敌方目标的等级                       |
| enemyResistance | 敌方抗性       | `number`        | 0      | 可选, 敌方目标对角色攻击的抗性             |
| enemyHpType     | 敌方血量类型   | `string`        | "生命" | 可选, 敌方目标的血量类型（生命/护盾/战姿） |
| targetFunction  | 目标函数       | `string`        | "伤害" | 可选, 计算目标函数（如伤害、DPS 等）       |

如:

```js
let options = {
    char: new LeveledChar("黎瑟"),
    hpPercent: 0.5,
    resonanceGain: 2,
    mods: [new LeveledMod(41324)],
    buffs: [new LeveledBuff("助战50攻", 1)],
    melee: new LeveledWeapon("铸铁者"),
    ranged: new LeveledWeapon("烈焰孤沙"),
    skillLevel: 10,
    baseName: "铸铁者",
    enemyType: "小型",
    enemyLevel: 80,
    enemyResistance: 0.5,
    enemyHpType: "生命",
    targetFunction: "伤害",
}
let cb = new CharBuild(options)
```

其中`class LeveledChar` 等定义位于`leveled.ts`

### 1.3 输出结果

- **目标函数结果**: `number` - 根据选择的目标函数计算得出的结果值

### 1.4 核心属性

#### 1.4.1 基础属性

| 属性名 | 类型     | 描述           |
| ------ | -------- | -------------- |
| 属性   | `string` | 角色的属性类型 |
| 攻击   | `number` | 角色的攻击力   |
| 生命   | `number` | 角色的生命值   |
| 护盾   | `number` | 角色的护盾值   |
| 防御   | `number` | 角色的防御力   |
| 神智   | `number` | 角色的神智值   |

#### 1.4.2 战斗属性

| 属性名   | 类型     | 描述                               |
| -------- | -------- | ---------------------------------- |
| 威力     | `number` | 影响伤害的核心属性                 |
| 耐久     | `number` | 影响技能持续时间的属性             |
| 效益     | `number` | 影响神智消耗的属性                 |
| 范围     | `number` | 影响技能范围的属性                 |
| 昂扬     | `number` | 生命值越高伤害越高的属性           |
| 背水     | `number` | 生命值越低伤害越高的属性           |
| 增伤     | `number` | 对伤害的直接加成                   |
| 独立增伤 | `number` | 对伤害的独立加成（与其他增伤相乘） |
| 武器伤害 | `number` | 对武器伤害的加成                   |
| 技能伤害 | `number` | 对技能伤害的加成                   |
| 属性穿透 | `number` | 无视敌方属性抗性的能力             |
| 无视防御 | `number` | 无视敌方防御的能力                 |

#### 1.4.3 技能相关属性

| 属性名   | 类型     | 描述                   |
| -------- | -------- | ---------------------- |
| 技能名称 | `string` | 技能的名称             |
| 攻击倍率 | `number` | 技能的攻击倍率         |
| 防御倍率 | `number` | 技能基于防御的倍率     |
| 生命倍率 | `number` | 技能基于生命的倍率     |
| 固定伤害 | `number` | 技能的固定伤害值       |
| 技能范围 | `number` | 技能的有效范围         |
| 技能持续 | `number` | 技能的持续时间         |
| 神智消耗 | `number` | 技能的神智消耗         |
| 持续消耗 | `number` | 技能持续期间的神智消耗 |
| 技能速度 | `number` | 技能的释放速度         |

#### 1.4.4 近战武器属性

| 属性名       | 类型     | 描述                 |
| ------------ | -------- | -------------------- |
| 近战类型     | `string` | 近战武器的类型       |
| 近战伤害类型 | `string` | 近战武器的伤害类型   |
| 近战攻击     | `number` | 近战武器的攻击力     |
| 近战暴击     | `number` | 近战武器的暴击率     |
| 近战暴伤     | `number` | 近战武器的暴击伤害   |
| 近战触发     | `number` | 近战武器的触发概率   |
| 近战攻速     | `number` | 近战武器的攻击速度   |
| 近战范围     | `number` | 近战武器的攻击范围   |
| 近战总攻击   | `number` | 近战武器的总攻击力   |
| 近战攻击倍率 | `number` | 近战武器的攻击倍率   |
| 近战连击等级 | `number` | 近战武器的连击等级   |
| 近战攻击段数 | `number` | 近战武器的攻击段数   |
| 近战增伤     | `number` | 对近战伤害的加成     |
| 近战独立增伤 | `number` | 对近战伤害的独立加成 |
| 近战追加伤害 | `number` | 近战武器的追加伤害   |

#### 1.4.5 远程武器属性

| 属性名       | 类型     | 描述                   |
| ------------ | -------- | ---------------------- |
| 远程类型     | `string` | 远程武器的类型         |
| 远程伤害类型 | `string` | 远程武器的伤害类型     |
| 远程弹道类型 | `string` | 远程武器的弹道类型     |
| 远程攻击     | `number` | 远程武器的攻击力       |
| 远程暴击     | `number` | 远程武器的暴击率       |
| 远程暴伤     | `number` | 远程武器的暴击伤害     |
| 远程触发     | `number` | 远程武器的触发概率     |
| 远程攻速     | `number` | 远程武器的攻击速度     |
| 远程多重     | `number` | 远程武器的多重射击次数 |
| 远程总攻击   | `number` | 远程武器的总攻击力     |
| 远程攻击倍率 | `number` | 远程武器的攻击倍率     |
| 远程增伤     | `number` | 对远程伤害的加成       |
| 远程独立增伤 | `number` | 对远程伤害的独立加成   |
| 远程追加伤害 | `number` | 远程武器的追加伤害     |

#### 1.4.6 同率武器属性

同率武器属性与近战/远程武器属性结构相同，前缀为"同率近战"或"同率远程"

## 2. 属性计算规则

### 2.1 角色属性计算

#### 2.1.1 有基础值的属性

| 属性类型                               | 受等级影响 | 等级系数                                                                                                                                                                                | 计算方式                                                | 结果处理                                              |
| -------------------------------------- | ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------- | ----------------------------------------------------- |
| 基础攻击、基础生命、基础护盾、基础防御 | 是         | 1 级: 0.079666848<br>10 级: 0.206300923<br>20 级: 0.302118414<br>30 级: 0.413724425<br>40 级: 0.529132718<br>50 级: 0.682636248<br>60 级: 0.813579576<br>70 级: 0.906300923<br>80 级: 1 | `属性 = 基础属性 * (1 + 武器加成 + MOD加成 + BUFF加成)` | 生命、护盾、防御、神智: 取整<br>攻击: 取小数点后 2 位 |
| 基础神智                               | 否         | -                                                                                                                                                                                       | `神智 = 基础神智 * (1 + 武器加成 + MOD加成 + BUFF加成)` | 取整                                                  |

#### 2.1.2 无基础值的属性

| 属性类型               | 起始值 | 计算方式                                   |
| ---------------------- | ------ | ------------------------------------------ |
| 大部分属性             | 0      | `加成 = 武器加成 + MOD加成 + BUFF加成`     |
| 威力、耐久、效益、范围 | 1      | `加成 = 1 + 武器加成 + MOD加成 + BUFF加成` |

#### 2.1.3 属性上限

| 属性 | 上限值 |
| ---- | ------ |
| 效益 | 175%   |
| 范围 | 280%   |

#### 2.1.4 加成计算特殊规则

1. **和鸣增益**: 攻击、生命、护盾、防御额外加上和鸣增益

    ```
    生命 = 基础生命 * (1 + 武器生命加成 + MOD生命加成 + BUFF生命加成 + 和鸣增益)
    ```

2. **属性伤加成**: 攻击额外乘以属性伤加成

    ```
    攻击 = 基础攻击 * (1 + 武器攻击加成 + MOD攻击加成 + BUFF攻击加成 + 和鸣增益) * (1 + 属性伤加成)
    ```

3. **累乘计算**: 无视防御和独立增伤采用累乘方式

    ```
    总加成 = (1 + 单个加成1) * (1 + 单个加成2) * ... - 1
    ```

4. **武器 MOD 前缀**: 武器 MOD 加成需根据武器类型添加前缀
    - 近战武器: 前缀"近战"
    - 远程武器: 前缀"远程"
    - 同率武器: 前缀"同率近战"或"同率远程"

### 2.2 武器属性计算

`interface Weapon` 定义位于`data-types.ts`, 实例如下:

```json
{
    "id": 20203,
    "名称": "蓝色脉动",
    "类型": "远程",
    "类别": "双枪",
    "伤害类型": "贯穿",
    "弹道类型": "弹道",
    "基础攻击": 239.49,
    "基础暴击": 0.2,
    "基础暴伤": 2.25,
    "基础触发": 0.25,
    "技能耐久": 0.3,
    "武器伤害": 0.9
}
```

#### 从 WeaponBase 中取值

WeaponBase 实例如下:

```json
{
    "武器类型": "双枪",
    "武器名称": "蓝色脉动,赘生,告谕圣音",
    "名称": "子弹伤害",
    "倍率": 0.47,
    "弹片数": 1,
    "射速": 2
}
```

从 base 表中查询与武器类型相同且如果武器名称包含 Weapon.名称则匹配到该 WeaponBase 实例(需要建立索引)

根据选择的`倍率名称`匹配 WeaponBase 实例中的`倍率,弹片数,射速,段数`到 LeveledWeapon 实例中

#### 2.2.1 有基础值的属性

| 属性                   | 计算方式                                            |
| ---------------------- | --------------------------------------------------- |
| 攻击、暴击、暴伤、触发 | `属性 = 基础值 * (1 + 对应加成1 + 对应加成2 + ...)` |

**特殊规则**:

- 攻击不计算角色攻击加成，需额外乘以武器物理加成
    ```
    近战攻击 = 近战基础攻击 * (1 + 近战攻击加成 + BUFF攻击加成 + BUFF近战攻击加成) * (1 + 近战物理加成)
    ```
- 武器类型与角色近战/远程相同时，武器攻击加成额外加 20%

#### 2.2.2 属性上限

| 属性 | 上限值 |
| ---- | ------ |
| 触发 | 100%   |

### 2.3 技能属性计算

#### 2.3.1 技能等级影响

技能等级影响属性值，计算公式：

```
最终技能属性 = 10级技能属性 / (1 + (10级技能属性/1级技能属性 - 1)/9 * (10 - 技能等级))
```

#### 2.3.2 角色属性对技能的影响

| 技能属性 | 影响因素           | 计算方式                                      |
| -------- | ------------------ | --------------------------------------------- |
| 技能范围 | 角色范围属性       | `技能范围 = 固定范围 + 基础技能范围 * 范围`   |
| 技能持续 | 角色耐久属性       | `技能持续 = 固定持续 + 基础技能持续 * 耐久`   |
| 神智消耗 | 角色效益属性       | `神智消耗 = 基础神智消耗 * (2 - 效益)`        |
| 持续消耗 | 角色效益和耐久属性 | `持续消耗 = 基础神智消耗 / 耐久 * (2 - 效益)` |

## 3. 伤害计算系统

### 3.1 核心乘区计算

#### 3.1.1 昂扬乘区

```
昂扬乘区 = 1 + 昂扬 * 当前生命百分比
```

#### 3.1.2 背水乘区

```
背水乘区 = 1 + 4 * 背水 * (1 - MAX(0.25, 当前生命百分比)) * (1.5 - MAX(0.25, 当前生命百分比))
```

#### 3.1.3 敌方类型系数

```
敌方类型系数 = {'小型': 13, '大型': 20, '首领': 30}[敌方类型]
```

#### 3.1.4 防御乘区

```
防御乘区 = 1 - (1 - (1 - 敌方类型系数/(30 + 敌方类型系数 - MAX(0, MIN(20, MIN(80, 敌方等级) - 角色等级))))) * (1 - 无视防御)
```

**特殊规则**: 如果敌方血量类型为**护盾**，则防御乘区固定为 1

### 3.2 技能伤害计算

#### 3.2.1 技能基础伤害

```
技能基础伤害 = 固定伤害 + 攻击倍率 * 攻击 + 生命倍率 * 角色基础生命 * 生命 + 防御倍率 * 防御
```

#### 3.2.2 技能伤害期望

```
技能伤害期望 = 技能基础伤害 * (1 - 敌方抗性 + 属性穿透) * 昂扬乘区 * 背水乘区 * 防御乘区 * (1 + 增伤 + 技能伤害) * (1 + 独立增伤)
```

### 3.3 武器伤害计算

#### 3.3.1 武器基础伤害

```
武器伤害物理部分 = 武器攻击倍率 * 武器攻击 * (1 + 物理)
武器伤害属性部分 = 武器攻击倍率 * 角色攻击
武器基础伤害 = 武器伤害物理部分 + 武器伤害属性部分
```

#### 3.3.2 触发伤害计算

| 伤害类型 | 额外伤害对象 | 触发伤害倍率         |
| -------- | ------------ | -------------------- |
| 切割     | 护盾         | `1 + 触发倍率加成`   |
| 震荡     | 战姿         | `0.5 + 触发倍率加成` |
| 贯穿     | 生命         | `1 + 触发倍率加成`   |

**触发伤害公式**:

```
武器伤害触发 = 武器伤害物理部分 * (1 + 触发伤害倍率) + 武器伤害属性部分
武器伤害未触发 = 武器伤害物理部分 + 武器伤害属性部分
武器伤害触发期望 = 武器伤害物理部分 * (1 + 触发伤害倍率 * 武器触发) + 武器伤害属性部分
```

#### 3.3.3 暴击伤害计算

**暴击伤害公式**:

```
武器伤害暴击上限 = 武器基础伤害 * 暴击伤害(高等级)
武器伤害暴击下限 = 武器基础伤害 * 暴击伤害(低等级)
武器伤害暴击期望 = 武器基础伤害 * (1 + 暴击率 * (暴击伤害 - 1))
```

**暴击等级规则**: 当暴击率超过 100%时，固定触发等级 1 的暴击，概率触发等级 2 的暴击, 以此类推. 若未暴击暴击等级视为 0

#### 3.3.4 完整武器伤害期望

```
武器伤害期望 = 武器攻击倍率 * (角色攻击 * (1 - 敌方抗性 + 属性穿透) + 武器伤害物理部分 * (1 + 触发伤害倍率 * 武器触发)) * (1 + 暴击率 * (暴击伤害 - 1)) * 昂扬乘区 * 背水乘区 * 防御乘区 * (1 + 增伤 + 武器伤害) * (1 + 独立增伤) * (1 + 追加伤害)
```

## 4. 目标函数

### 4.1 目标函数类型

| 目标函数           | 缩写   | 描述                           |
| ------------------ | ------ | ------------------------------ |
| 伤害               | DPA    | 单次攻击或技能的伤害期望       |
| 每秒伤害           | DPS    | 单位时间内的伤害期望           |
| 每神智伤害         | DPAPM  | 消耗单位神智的伤害期望         |
| 每持续神智伤害     | DPAPSM | 消耗单位持续神智的伤害期望     |
| 每神智每秒伤害     | DPSPM  | 消耗单位神智的每秒伤害期望     |
| 每持续神智每秒伤害 | DPSPSM | 消耗单位持续神智的每秒伤害期望 |

### 4.2 目标函数计算公式

```
伤害(DPA) = 技能伤害期望 或 武器伤害期望
每秒伤害(DPS) = 技能伤害期望 * 技能速度 或 武器伤害期望 * 武器射速 * 武器多重
每神智伤害(DPAPM) = 伤害(DPA) / 神智消耗
每持续神智伤害(DPAPSM) = 伤害(DPA) / 持续消耗
每神智每秒伤害(DPSPM) = 每秒伤害(DPS) / 神智消耗
每持续神智每秒伤害(DPSPSM) = 每秒伤害(DPS) / 持续消耗
```

## 5. 术语定义

| 术语          | 定义                             |
| ------------- | -------------------------------- |
| LeveledChar   | 包含角色及其等级信息的对象       |
| LeveledMod    | 包含 MOD 及其等级信息的对象      |
| LeveledBuff   | 包含 BUFF 及其等级信息的对象     |
| LeveledWeapon | 包含武器及其等级信息的对象       |
| LeveledSkill  | 包含技能及其等级信息的对象       |
| 和鸣增益      | 角色的和鸣效果带来的额外属性加成 |
| 独立增伤      | 与其他增伤相乘计算的伤害加成     |
| 属性穿透      | 无视敌方属性抗性的能力           |
| 无视防御      | 无视敌方防御的能力               |
| 神智消耗      | 使用技能所需的神智点数           |
| 持续消耗      | 技能持续期间每秒消耗的神智点数   |

## 6. 输出结果

- **目标函数结果**: `<number>` - 根据选择的目标函数计算得出的最终结果值
