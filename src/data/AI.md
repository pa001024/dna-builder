## 基本定义

类名`CharBuild`

### 属性

- 属性`<string>`
- 攻击`<number>`
- 生命`<number>`
- 护盾`<number>`
- 防御`<number>`
- 神智`<number>`
- 威力`<number>`
- 耐久`<number>`
- 效益`<number>`
- 范围`<number>`
- 昂扬`<number>`
- 背水`<number>`
- 增伤`<number>`
- 独立增伤`<number>`
- 武器伤害`<number>`
- 技能伤害`<number>`
- 属性穿透`<number>`
- 技能名称`<string>`
- 攻击倍率`<number>`
- 防御倍率`<number>`
- 生命倍率`<number>`
- 固定伤害`<number>`
- 技能范围`<number>`
- 技能持续`<number>`
- 神智消耗`<number>`
- 持续消耗`<number>`
- 技能速度`<number>`
- 无视防御`<number>`
- 异常数量`<number>`
- 神智回复`<number>`
- 耗尽时间`<number>`
- 近战类型`<string>`
- 近战伤害类型`<string>`
- 近战攻击`<number>`
- 近战暴击`<number>`
- 近战暴伤`<number>`
- 近战触发`<number>`
- 近战攻速`<number>`
- 近战范围`<number>`
- 近战总攻击`<number>`
- 近战攻击倍率`<number>`
- 近战连击等级`<number>`
- 近战攻击段数`<number>`
- 近战增伤`<number>`
- 近战独立增伤`<number>`
- 近战追加伤害`<number>`
- 远程类型`<string>`
- 远程伤害类型`<string>`
- 远程弹道类型`<string>`
- 远程攻击`<number>`
- 远程暴击`<number>`
- 远程暴伤`<number>`
- 远程触发`<number>`
- 远程攻速`<number>`
- 远程多重`<number>`
- 远程总攻击`<number>`
- 远程攻击倍率`<number>`
- 远程增伤`<number>`
- 远程独立增伤`<number>`
- 远程追加伤害`<number>`
- 同率近战类型`<string>`
- 同率近战伤害类型`<string>`
- 同率近战攻击`<number>`
- 同率近战暴击`<number>`
- 同率近战暴伤`<number>`
- 同率近战触发`<number>`
- 同率近战攻速`<number>`
- 同率近战范围`<number>`
- 同率近战总攻击`<number>`
- 同率近战攻击倍率`<number>`
- 同率近战连击等级`<number>`
- 同率近战攻击段数`<number>`
- 同率近战增伤`<number>`
- 同率近战独立增伤`<number>`
- 同率近战追加伤害`<number>`
- 同率远程类型`<string>`
- 同率远程伤害类型`<string>`
- 同率远程弹道类型`<string>`
- 同率远程攻击`<number>`
- 同率远程暴击`<number>`
- 同率远程暴伤`<number>`
- 同率远程触发`<number>`
- 同率远程攻速`<number>`
- 同率远程多重`<number>`
- 同率远程总攻击`<number>`
- 同率远程攻击倍率`<number>`
- 同率远程增伤`<number>`
- 同率远程独立增伤`<number>`
- 同率远程追加伤害`<number>`

### 参数

-   角色与等级`<LeveledChar>`
-   当前生命百分比`<number>`
-   和鸣增益`<number>`
-   角色 MOD 列表`<LeveledMod[]>`
-   BUFF 列表`<LeveledBuff[]>`
-   近战武器与等级`<LeveledWeapon[]>`
-   远程武器与等级`<LeveledWeapon[]>`
-   武器或技能名`<string>`
-   敌方类型`<string>`
-   敌方等级`<number>`
-   敌方抗性`<number>`
-   敌方血量类型`<string>`
-   目标函数`<string>`

### 角色属性

#### 有基础值的属性

基础攻击,基础生命,基础护盾,基础防御受角色等级影响
`1,10,20,30,40,50,60,70,80`级时的属性分别为 80 级的`0.079666848,0.206300923,0.302118414,0.413724425,0.529132718,0.682636248,0.813579576,1`倍

基础神智不受等级影响

攻击,生命,护盾,防御,神智计算时要乘以其基础值, 如
`攻击 = 基础攻击 * (1 + 武器攻击加成 + 角色MOD攻击加成 + BUFF攻击加成)`

生命,护盾,防御,神智的计算结果要取整, 攻击的计算结果取小数点后 2 位

#### 没有基础值的属性

大部分属性都没有基础值, 加成从 0 开始计算
`武器加成 + 角色MOD加成 + BUFF加成`

威力,耐久,效益,范围没有基础值, 但是从 1 开始计算
`1 + 武器加成 + 角色MOD加成 + BUFF加成`

#### 属性上限

效益,范围具有上限, 最后计算结果不能超过上限

-   效益上限为 175%
-   范围上限为 280%

#### 属性的显示

大部分的属性都显示为百分比

神智回复显示为整数

#### 加成计算

除无视防御和独立增伤之外, 其余属性的加成计算为:
`某加成 = 基础属性 * (1 + 武器某加成 + 角色MOD某加成 + BUFF某加成)`

其中攻击,生命,护盾,防御还要额外加上和鸣增益, 如:
`生命 = 基础生命 * (1 + 武器生命加成 + 角色MOD生命加成 + BUFF生命加成 + 和鸣增益)`

攻击还要额外乘以属性伤
`攻击 = 基础攻击 * (1 + 武器攻击加成 + 角色MOD攻击加成 + BUFF攻击加成 + 和鸣增益) * (1 + 属性伤加成)`

无视防御和独立增伤的计算方式为累乘
`(1 + 单个加成) * (1 + 单个加成) * (1 + 单个加成) ... - 1`

如非特别说明, 武器 MOD 加成仅对该武器生效, 所有武器 MOD 计算时根据类别需要加上近战,远程,同率近战或同率远程的前缀, 比如远程武器 MOD`迅捷`增加了攻速,则计算时将其视为`远程攻速`词条计算

### 武器属性

基础攻击受武器等级影响, 影响方式与角色相同

#### 有基础值的属性

攻击,暴击,暴伤,触发,射速,多重计算时要乘以其基础值, 如
`近战暴击 = 近战基础暴击 * (1 + 暴击加成 + 近战暴击加成 + BUFF暴击加成 + BUFF近战暴击加成)`

其中攻击不计算角色攻击加成, 还需要乘以武器物理加成
`近战攻击 = 近战基础攻击 * (1 + 近战攻击加成 + BUFF攻击加成 + BUFF近战攻击加成) * (1 + 近战物理加成)`

当武器类型与角色的近战或远程相同时, **武器攻击加成**额外加 20%

#### 属性上限

触发的上限为 100%

### 技能属性

技能属性包括:

-   伤害类型
-   攻击倍率
-   防御倍率
-   生命倍率
-   固定伤害
-   技能持续
-   固定持续
-   技能范围
-   固定范围
-   神智消耗
-   持续消耗

#### 技能等级变化

`Skill` 数据中以等级标注了 1 级和 10 级技能数据:
由输入的技能等级来计算最终的技能数据:
`最终技能数据 = 10级技能数据 / (1 + (10级技能数据/1级技能数据-1)/9 * (10-技能等级))`

#### 属性影响

技能范围受角色的范围影响, 计算方式为:
`技能范围 = 固定范围 + 基础技能范围 * 范围`
技能持续受角色的耐久影响, 计算方式为:
`技能持续 = 固定持续 + 基础技能持续 * 耐久`
神智消耗受角色的效益影响, 计算方式为:
`神智消耗 = 基础神智消耗 * (2 - 效益)`
持续消耗受角色的效益和耐久影响, 计算方式为:
`神智消耗 = 基础神智消耗 / 耐久 * (2 - 效益)`

### 伤害

`昂扬乘区 = 1 + 昂扬 * 当前生命百分比`

`背水乘区 = 1 + 4 * 背水 * (1 - MAX(0.25,当前生命百分比)) * (1.5 - MAX(0.25,当前生命百分比))`

`敌方类型系数 = {'小型':13,'大型':20,'首领':30}[敌方类型]`

`防御乘区 = 1 - (1 - (1 - 敌方类型系数/(30 + 敌方类型系数 - MAX(0, MIN(20, MIN(80,敌方等级) - 角色等级))))) * (1 - 无视防御)`

如果敌方血量类型为**护盾**, 则**防御乘区**固定为 1

#### 技能伤害

`技能基础伤害 = 固定伤害 + 攻击倍率 * 攻击 + 生命倍率 * 角色基础生命 * 生命 + 防御倍率 * 防御`

`技能伤害期望 = 技能基础伤害 * (1 - 敌方抗性 + 属性穿透) * 昂扬乘区 * 背水乘区 * 防御乘区 * (1 + 增伤 + 技能伤害) * (1 + 独立增伤)`

#### 武器伤害

`武器伤害物理部分 = 武器攻击倍率 * 武器攻击 * (1 + 物理)`
`武器伤害属性部分 = 武器攻击倍率 * 角色攻击`
`武器基础伤害 = 武器伤害物理部分 + 武器伤害属性部分`

##### 触发

武器的伤害类型对对应的敌方血量类型造成额外伤害效果, 只影响武器伤害物理部分

-   切割伤害在触发时会对护盾造成额外伤害, 倍率为`1 + 触发倍率加成`
-   震荡伤害在触发时会对战姿造成额外伤害, 倍率为`0.5 + 触发倍率加成`
-   贯穿伤害在触发时会对生命造成额外伤害, 倍率为`1 + 触发倍率加成`

当武器伤害类型与指定的敌方血量类型相同时, 需要计算触发倍率加成, 将伤害分为触发, 未触发, 期望三种

`武器伤害触发 = 武器伤害物理部分 * (1 + 触发伤害倍率) + 武器伤害属性部分`
`武器伤害未触发 = 武器伤害物理部分 + 武器伤害属性部分`
`武器伤害触发期望 = 武器伤害物理部分 * (1 + 触发伤害倍率 * 武器触发) + 武器伤害属性部分`

##### 暴击

武器伤害会暴击, 根据暴击率的不同, 会有不同的暴击等级
当暴击率超过 100%时, 固定触发等级 1 的暴击, 概率触发等级 2 的暴击, 此时`暴击伤害 = (暴击伤害 - 1) * 暴击等级 + 1`
暴击将伤害分为上限, 下限, 期望三种, 分别为:

`武器伤害暴击上限 = 武器基础伤害 * 暴击伤害(高等级)`
`武器伤害暴击下限 = 武器基础伤害 * 暴击伤害(低等级)`
`武器伤害暴击期望 = 武器基础伤害 * (1 + 暴击率 * (暴击伤害 - 1))`

##### 同时计算暴击和触发期望

`武器伤害期望 = 武器攻击倍率 * (角色攻击 * (1 - 敌方抗性 + 属性穿透) + 武器伤害物理部分 * (1 + 触发伤害倍率 * 武器触发)) * (1 + 暴击率 * (暴击伤害 - 1)) * 昂扬乘区 * 背水乘区 * 防御乘区 * (1 + 增伤 + 武器伤害) * (1 + 独立增伤) * (1 + 追加伤害)`

### 目标函数

目标函数分为:

-   伤害(DPA)
-   每秒伤害(DPS)
-   每神智伤害(DPAPM)
-   每持续神智伤害(DPAPSM)
-   每神智每秒伤害(DPSPM)
-   每持续神智每秒伤害(DPSPSM)

`伤害(DPA) = 技能伤害期望或武器伤害期望`
`每秒伤害(DPS) = 技能伤害期望 * 技能速度 或 武器伤害期望 * 武器射速 * 武器多重 / 武器基础多重`
`每神智伤害(DPAPM) = 伤害(DPA) / 神智消耗`
`每持续神智伤害(DPAPSM) = 伤害(DPA) / 持续消耗`
`每神智每秒伤害(DPSPM) = 每秒伤害(DPS) / 神智消耗`
`每持续神智每秒伤害(DPSPSM) = 每秒伤害(DPS) / 持续消耗`

### 输出

-   目标函数结果`<number>`
